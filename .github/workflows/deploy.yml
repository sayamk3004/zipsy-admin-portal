name: Deploy (push to main)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS via SSH (run deploy on VPS)
        env:
          DEPLOY_HOST: ${{ secrets.SERVER_HOST }}
          DEPLOY_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.SERVER_PATH }}
          DEPLOY_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          set -e

          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            set -e

            cd /var/www/vhosts/zipsy.co.uk/admin.zipsy.co.uk

            PHP="/opt/plesk/php/8.3/bin/php"

            echo "=== Using PHP ==="
            if [ -x "$PHP" ]; then
              ls -la "$PHP"
              "$PHP" -v
            else
              echo "Plesk PHP 8.3 not found, using system php"
              PHP="php"
              "$PHP" -v
            fi

            echo "=== Composer ==="
            which composer || true
            composer -V || true

            echo "=== Update repo ==="
            git fetch origin
            git checkout main
            git reset --hard origin/main

            echo "=== Clean frontend deps ==="
            rm -rf node_modules || true

            echo "=== Install backend deps (force PHP) ==="
            "$PHP" $(command -v composer) install --no-interaction --prefer-dist --no-dev --optimize-autoloader

            echo "=== NPM install + build (if package.json exists) ==="
            if [ -f package.json ]; then
              if [ -f package-lock.json ]; then
                npm ci
              else
                npm install
              fi
              npm run build
            else
              echo "No package.json, skipping frontend build"
            fi

            echo "=== Laravel tasks (force PHP) ==="
            if [ -f artisan ]; then
              "$PHP" artisan migrate --force || true
              "$PHP" artisan optimize:clear || true
              "$PHP" artisan config:cache || true
              "$PHP" artisan route:cache || true
              "$PHP" artisan view:cache || true
              "$PHP" artisan queue:restart || true

              mkdir -p storage bootstrap/cache
              chmod -R ug+rw storage bootstrap/cache || true
            else
              echo "artisan not found, skipping Laravel commands"
            fi

            echo "=== Deploy finished ==="
          EOF
